{"version":3,"sources":["../src/Memory.js"],"names":["Memory","Storage","add","item","name","items","Error","instance","grants","remove","Object","keys","forEach","itemName","filter","grant","role","child","childName","Role","includes","push","revoke","get","undefined","getRoles","reduce","filtered","getPermissions","Permission","getGrants","currentGrants","grantName"],"mappings":"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","sourcesContent":["// @flow\nimport Storage from './Storage';\nimport Permission from './Permission';\nimport Role from './Role';\nimport Base from './Base';\n\nexport default class Memory extends Storage {\n  items: Object[] = {};\n\n  async add(item: Base): boolean {\n    const { name } = item;\n    if (this.items[name]) {\n      throw new Error(`Item ${name} already exists`);\n    }\n\n    this.items[name] = {\n      instance: item,\n      grants: [],\n    };\n\n    return true;\n  }\n\n  async remove(item: Base): boolean {\n    const { items } = this;\n    const { name } = item;\n    if (!items[name]) {\n      throw new Error(`Item ${name} is not presented in storage`);\n    }\n\n    // revoke from all instances\n    Object.keys(items).forEach((itemName: string) => {\n      const { grants } = items[itemName];\n      items[itemName].grants = grants.filter(grant => grant !== name);\n    });\n\n    // delete from items\n    delete this.items[name];\n    return true;\n  }\n\n  async grant(role: Role, child: Base): boolean {\n    const { name } = role;\n    const { name: childName } = child;\n\n    if (!this.items[name]) {\n      throw new Error(`Role ${name} is not exist`);\n    }\n\n    if (!this.items[childName]) {\n      throw new Error(`Base ${childName} is not exist`);\n    }\n\n    if (!(role instanceof Role)) {\n      throw new Error('Role is not instance of Role');\n    }\n\n    if (name === childName) {\n      throw new Error(`You can grant yourself ${name}`);\n    }\n\n    const { grants } = this.items[name];\n    if (!grants.includes(childName)) {\n      grants.push(childName);\n    }\n\n    return true;\n  }\n\n  async revoke(role: Role, child: Base): boolean {\n    const { name } = role;\n    const { name: childName } = child;\n\n    if (!this.items[name] || !this.items[childName]) {\n      throw new Error('Role is not exist');\n    }\n\n    const { grants } = this.items[name];\n    if (!grants.includes(childName)) {\n      throw new Error('Item is not associated to this item');\n    }\n\n    this.items[name].grants = grants.filter(grant => grant !== childName);\n\n    return true;\n  }\n\n  async get(name: string): ?Base {\n    if (name && this.items[name]) {\n      return this.items[name].instance;\n    }\n\n    return undefined;\n  }\n\n  async getRoles(): Role[] {\n    return this.items\n      .reduce((filtered: Role[], item: Object) => {\n        const { instance } = item;\n\n        if (instance instanceof Role) {\n          filtered.push(instance);\n        }\n\n        return filtered;\n      }, []);\n  }\n\n  async getPermissions(): Permission[] {\n    return this.items\n      .reduce((filtered: Permission[], item: Object) => {\n        const { instance } = item;\n\n        if (instance instanceof Permission) {\n          filtered.push(instance);\n        }\n\n        return filtered;\n      }, []);\n  }\n\n  async getGrants(role: string): Base[] {\n    if (role && this.items[role]) {\n      const currentGrants = this.items[role].grants;\n\n      return currentGrants.reduce((filtered: Object[], grantName: string) => {\n        const grant = this.items[grantName];\n        if (grant) {\n          filtered.push(grant.instance);\n        }\n\n        return filtered;\n      }, []);\n    }\n\n    return [];\n  }\n}\n"],"file":"Memory.js"}